rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read and write their own user document
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId && request.auth.token.email_verified == true;
      // Users can create their own document (handled by auth trigger ideally, but rule covers direct creation)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated users to read and write their personalWallet subcollection
      match /personalWallet/{walletId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Business account access
    match /businessAccounts/{businessId} {
      // Admins can manage business details (update)
      allow read, update: if hasBusinessRole(businessId, 'admin');
      // Team members can view business details
      allow read: if hasBusinessRole(businessId, 'member');

      // Team management
      match /teamMembers/{memberId} {
        allow read: if hasBusinessRole(businessId, 'member');
        allow create, update, delete: if hasBusinessRole(businessId, 'admin');
      }

      // Corporate wallets
      match /corporateWallets/{walletId} {
        allow read: if hasBusinessRole(businessId, 'member');
        allow create, update, delete: if hasBusinessRole(businessId, 'accountant') || hasBusinessRole(businessId, 'admin');
      }
    }
    // Deny all other access by default (implicitly handled by lack of other rules)
    function hasBusinessRole(businessId, requiredRole) {
      return request.auth != null && request.auth.token['business_' + businessId] == requiredRole;
    }
  }
}
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read and write their own user document
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      // Users can create their own document (handled by auth trigger ideally, but rule covers direct creation)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated users to read and write their personalWallet subcollection
      match /personalWallet/{walletId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Business account access
    match /businessAccounts/{businessId} {
      // Admins can manage business details (update)
      allow read, update: if hasBusinessRole(businessId, 'admin') && validateTransactionRequest();
      // Team members can view business details
      allow read: if hasBusinessRole(businessId, 'member');

      // Team management
      match /teamMembers/{memberId} {
        allow read: if hasBusinessRole(businessId, 'member');
        allow create, update, delete: if hasBusinessRole(businessId, 'admin') && validateTransactionRequest();
      }

      // Corporate wallets
      match /corporateWallets/{walletId} {
        allow read: if hasBusinessRole(businessId, 'member');
        allow create, update, delete: if (hasBusinessRole(businessId, 'accountant') || hasBusinessRole(businessId, 'admin')) && processSecureTransaction();
      }
    }

    // Security and Audit Logs (Only accessible via Admin SDK or authorized Cloud Functions)
    match /auditLogs/{logId} {
      allow read, write: if false;
    }
    match /securityEvents/{eventId} {
      allow read, write: if false;
    }

    // Helper function to check business roles
    function hasBusinessRole(businessId, requiredRole) {
      return request.auth != null && request.auth.token['business_' + businessId] == requiredRole;
    }

    // Placeholder functions for security checks (Implement logic in Cloud Functions)
    function assessSignInRisk() { return true; }
    function monitorAuthAttempts() { return true; }
    function manageSessions() { return true; }
    function processSecureTransaction() { return true; }
    function validateTransactionRequest() { return true; }
    function checkEncryptionKeys() { return true; }
    function checkAuthenticationSettings() { return true; }
    function checkFunctionPermissions() { return true; }
    function checkNetworkSecurity() { return true; }
    function logSecurityEvent() { return true; }
    function monitorAnomalies() { return true; }
    function securityHealthCheck() { return true; }
    function manageDataRetention() { return true; }
    function processDataDeletionRequest() { return true; }
  }
}