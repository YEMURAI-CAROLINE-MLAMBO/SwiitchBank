rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      // Users can create their own document (handled by auth trigger ideally, but rule covers direct creation)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Additional security for sensitive fields - Only verified users can read sensitive data
      match /sensitive/{document} {
        allow read: if request.auth != null && request.auth.uid == userId && request.auth.token.email_verified == true;
        allow write: if false; // Sensitive data should only be written by trusted backend services
      }

      match /personalWallet/{walletId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Business account access
    match /businessAccounts/{businessId} {
      // Admins can manage business details
      allow read, update: if hasBusinessRole(businessId, 'admin');
      // Team members can view business details
      allow read: if hasBusinessRole(businessId, 'member');

      // Team management
      match /teamMembers/{memberId} {
        allow read: if hasBusinessRole(businessId, 'member') || hasBusinessRole(businessId, 'admin');
        allow create, update, delete: if hasBusinessRole(businessId, 'admin');
      }

      // Corporate wallets
      match /corporateWallets/{walletId} {
        allow read: if hasBusinessRole(businessId, 'member');
        allow create, update, delete: if hasBusinessRole(businessId, 'accountant') || hasBusinessRole(businessId, 'admin');
      }

      // Placeholder functions for security checks (Implement logic in Cloud Functions)
      // These functions are kept for compatibility with existing rules but should ideally be backend checks
      function validateTransactionRequest() { return true; }
      function processSecureTransaction() { return true; }
    }

    // Wallets collection (top-level)
    match /wallets/{walletId} {
      // Users can only read their own wallets
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Wallet updates (like balance changes) should be handled by trusted backend services
      allow write: if false;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Security and Audit Logs (Only accessible via Admin SDK or authorized Cloud Functions)
    function hasBusinessRole(businessId, requiredRole) {
      return request.auth != null && request.auth.token['business_' + businessId] == requiredRole;
    }
  }